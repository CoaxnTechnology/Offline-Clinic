name: Deploy to Bluehost VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to Bluehost VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.BLUEHOST_HOST }}
          username: ${{ secrets.BLUEHOST_USER }}
          key: ${{ secrets.BLUEHOST_SSH_KEY }}
          script: |
            set -e
            
            cd /var/www/Offline-Clinic
            
            echo " Starting deployment..."
            
            # Backup current version
            if [ -d ".git" ]; then
              echo " Creating backup..."
              cp -r . ../Offline-Clinic-backup-$(date +%Y%m%d-%H%M%S) || true
            fi
            
            # Pull latest code
            echo " Pulling latest code..."
            git fetch origin
            git reset --hard origin/main
            
            # Handle virtual environment (must use 'venv' to match systemd service)
            if [ -d "venv" ]; then
              echo " Activating venv..."
              source venv/bin/activate
            elif [ -d ".venv" ]; then
              echo " Renaming .venv to venv to match systemd service..."
              mv .venv venv
              source venv/bin/activate
            else
              echo " Creating virtual environment..."
              python3.11 -m venv venv
              source venv/bin/activate
            fi
            
            # Install dependencies
            echo " Installing dependencies..."
            if command -v uv &> /dev/null; then
              echo "Using uv sync..."
              uv sync
            else
              echo "Using pip install..."
              pip install --upgrade pip
              pip install -r requirements.txt
            fi
            
            # Verify gunicorn is installed (required by systemd service)
            if ! command -v gunicorn &> /dev/null; then
              echo " Installing gunicorn..."
              pip install gunicorn
            fi
            
            # Load environment variables (skip comments and empty lines)
            echo " Loading environment variables..."
            if [ -f ".env" ]; then
              set -a
              while IFS= read -r line || [ -n "$line" ]; do
                # Skip comments and empty lines
                if [[ "$line" =~ ^[[:space:]]*# ]] || [[ -z "${line// }" ]]; then
                  continue
                fi
                # Export the variable
                export "$line"
              done < .env
              set +a
            else
              echo "  Warning: .env file not found"
            fi
            
            # Run database migrations
            echo "ðŸ—„ï¸  Running database migrations..."
            flask db upgrade
            
            # Create storage directories if they don't exist
            echo " Creating storage directories..."
            mkdir -p dicom_files thumbnails reports logs
            chmod 755 dicom_files thumbnails reports
            
            # Restart application
            echo " Restarting application..."
            sudo systemctl restart Offline-Clinic
            
            # Wait for service to start
            echo " Waiting for service to start..."
            sleep 5
            
            # Health check
            echo " Running health check..."
            if curl -f http://localhost:5000/health; then
              echo " Health check passed"
            else
              echo " Health check failed"
              sudo journalctl -u Offline-Clinic -n 50 --no-pager
              exit 1
            fi
            
            # Check service status
            echo "Service status:"
            sudo systemctl status Offline-Clinic --no-pager || true
            
            echo "âœ… Deployment successful!"
