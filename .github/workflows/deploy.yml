name: Deploy to Bluehost VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to Bluehost VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.BLUEHOST_HOST }}
          username: ${{ secrets.BLUEHOST_USER }}
          key: ${{ secrets.BLUEHOST_SSH_KEY }}
          script: |
            set -e

            cd /var/www/Offline-Clinic

            if [ -d ".git" ]; then
              cp -r . ../Offline-Clinic-backup-$(date +%Y%m%d-%H%M%S) || true
            fi

            git fetch origin
            git reset --hard origin/main

            if [ -d ".venv" ]; then
              source .venv/bin/activate
              VENV_PATH=".venv"
            elif [ -d "venv" ]; then
              source venv/bin/activate
              VENV_PATH="venv"
            else
              echo "Creating virtual environment..."
              python3.11 -m venv .venv
              source .venv/bin/activate
              VENV_PATH=".venv"
            fi

            if command -v uv &> /dev/null; then
              echo "Using uv sync..."
              uv sync
            else
              echo "uv not found, using pip..."
              pip install --upgrade pip
              pip install -r requirements.txt
            fi

            # Load environment variables (skip comments and empty lines)
            set -a
            source <(grep -v '^#' .env | grep -v '^$' | sed 's/^/export /')
            set +a

            flask db upgrade

            sudo systemctl restart Offline-Clinic

            sleep 5

            curl -f http://localhost:5000/health || exit 1

            sudo systemctl status Offline-Clinic --no-pager || true

            echo "âœ… Deployment successful!"
