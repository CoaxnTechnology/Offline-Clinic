name: Deploy to Bluehost VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to Bluehost VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.BLUEHOST_HOST }}
          username: ${{ secrets.BLUEHOST_USER }}
          key: ${{ secrets.BLUEHOST_SSH_KEY }}
          script: |
            set -e
            
            cd /opt/Offline-Clinic
            
            echo " Starting deployment..."
            
            # Backup current version
            if [ -d ".git" ]; then
              echo " Creating backup..."
              cp -r . ../Offline-Clinic-backup-$(date +%Y%m%d-%H%M%S) || true
            fi
            
            # Pull latest code
            echo " Pulling latest code..."
            git fetch origin
            git reset --hard origin/main
            
            # Handle virtual environment (using venv)
            if [ -d "venv" ]; then
              echo " Activating venv..."
              source venv/bin/activate
            else
              echo " Creating virtual environment..."
              python3.11 -m venv venv
              source venv/bin/activate
            fi
            
            # Install dependencies
            echo " Installing dependencies..."
            if command -v uv &> /dev/null; then
              echo "Using uv sync..."
              uv sync
              # Ensure gunicorn is installed (uv might not install it properly)
              echo " Ensuring gunicorn is installed..."
              pip install --quiet gunicorn || echo "Gunicorn already installed"
            else
              echo "Using pip install..."
              pip install --upgrade pip
              pip install -r requirements.txt
            fi
            
            # Verify gunicorn is installed (required by systemd service)
            echo " Verifying gunicorn installation..."
            if [ ! -f "venv/bin/gunicorn" ]; then
              echo " WARNING: gunicorn not found, installing..."
              pip install gunicorn
            fi
            
            # Verify gunicorn exists and is executable
            if [ ! -f "venv/bin/gunicorn" ]; then
              echo " ERROR: gunicorn not found after installation!"
              echo " Listing venv/bin contents:"
              ls -la venv/bin/ | head -20
              exit 1
            fi
            
            # Fix permissions for venv/bin directory and gunicorn
            echo " Setting permissions on venv/bin..."
            chmod +x venv/bin
            chmod +x venv/bin/gunicorn
            echo " Gunicorn path: $(pwd)/venv/bin/gunicorn"
            echo " Gunicorn exists: $([ -f venv/bin/gunicorn ] && echo 'YES' || echo 'NO')"
            echo " Gunicorn permissions: $(ls -l venv/bin/gunicorn | awk '{print $1, $3, $4}')"
            
            # Set proper ownership (apache user needs access)
            echo " Setting ownership for apache user..."
            sudo chown -R apache:apache /opt/Offline-Clinic
            sudo chmod -R 755 /opt/Offline-Clinic
            sudo chmod +x /opt/Offline-Clinic/venv/bin
            sudo chmod +x /opt/Offline-Clinic/venv/bin/gunicorn
            
            # Verify ownership after setting
            echo " Verifying ownership..."
            ls -l /opt/Offline-Clinic/venv/bin/gunicorn
            
            # Load environment variables (skip comments and empty lines)
            echo " Loading environment variables..."
            if [ -f ".env" ]; then
              set -a
              while IFS= read -r line || [ -n "$line" ]; do
                # Skip comments and empty lines
                if [[ "$line" =~ ^[[:space:]]*# ]] || [[ -z "${line// }" ]]; then
                  continue
                fi
                # Export the variable
                export "$line"
              done < .env
              set +a
            else
              echo "  Warning: .env file not found"
            fi
            
            # Run database migrations
            echo "ðŸ—„ï¸  Running database migrations..."
            flask db upgrade
            
            # Create storage directories if they don't exist
            echo " Creating storage directories..."
            mkdir -p dicom_files thumbnails reports logs
            chmod 755 dicom_files thumbnails reports
            
            # Restart application
            # Verify gunicorn before restarting
            if [ ! -f "/opt/Offline-Clinic/venv/bin/gunicorn" ]; then
              echo " ERROR: gunicorn not found at expected path!"
              ls -la /opt/Offline-Clinic/venv/bin/ | grep gunicorn || echo "No gunicorn in venv/bin"
              exit 1
            fi
            
            echo " Restarting application..."
            sudo systemctl daemon-reload
            sudo systemctl restart clinic-backend
            
            # Wait for service to start
            echo " Waiting for service to start..."
            sleep 5
            
            # Health check
            echo " Running health check..."
            if curl -f http://localhost:5000/health; then
              echo " Health check passed"
            else
              echo " Health check failed"
              sudo journalctl -u clinic-backend -n 50 --no-pager
              exit 1
            fi
            
            # Check service status
            echo "Service status:"
            sudo systemctl status clinic-backend --no-pager || true
            
            echo "âœ… Deployment successful!"
